ğŸ›ï¸ Monitoraggio Affluenza Turisti con Raspberry Pi e Computer Vision
Progetto: Sistema automatico e non invasivo per il conteggio e l'analisi dell'affluenza di visitatori (turisti) in aree specifiche di un bene culturale, operativo per l'intera giornata.
1. ğŸ“– Concetto e Funzionamento
Il sistema utilizza la libreria OpenCV su un Raspberry Pi per l'analisi del flusso video (Computer Vision). Non salva alcuna immagine, ma registra solo dati numerici aggregati (conteggio e orario).
Flusso Operativo
	1	Avvio (Cron): Il sistema si avvia automaticamente all'orario di apertura (es. 08:00) tramite un job scheduler (Cron).
	2	Cattura Video: Acquisisce il flusso video dalla telecamera collegata (USB o CSI).
	3	Rilevamento Persone: Ogni 5 secondi, analizza un frame utilizzando il modello Haar Cascade per rilevare la presenza di corpi umani.
	4	Registrazione: Scrive il conteggio delle persone rilevate in quel momento nel file di log (presenze_log.txt).
	5	Chiusura: Al termine dell'orario stabilito (MONITORING_DURATION_MINUTES), invia il log completo via email e chiude il programma, eliminando il log locale.
2. ğŸ“‹ Requisiti Tecnici
Componente
Requisito
Note
Hardware
Raspberry Pi 4
Consigliato per le prestazioni di calcolo video.
OS
Raspberry Pi OS (o altra distro Linux)
Compatibile con Python e OpenCV.
Telecamera
USB o CSI
Posizionamento cruciale per ottimizzare il campo visivo.
Email
Account Gmail
Ãˆ obbligatorio usare una "Password per App" se si ha l'autenticazione a due fattori attiva.
3. âš™ï¸ Installazione e Setup
Assumi che la directory del progetto sia ~/Downloads/Vision.
Passo 3.1: Dipendenze Python e Ambiente
Crea e attiva l'ambiente virtuale (se non giÃ  fatto) e installa le librerie richieste.
cd ~/Downloads/Visionâ€¨# source venv/bin/activateÂ  # Attiva l'ambiente se non giÃ  attivoâ€¨pip install opencv-python python-dotenvâ€¨
Passo 3.2: Modello di Rilevamento (Haar Cascade)
Scarica il file del modello pre-addestrato nella directory del progetto.
wget [https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_fullbody.xml](https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_fullbody.xml) -O haarcascade_fullbody.xmlâ€¨
Passo 3.3: Configurazione delle Credenziali (.env)
Crea un file chiamato .env nella directory principale e inserisci i dettagli di configurazione.
nano .envâ€¨
EMAIL_SENDER="tua_email@gmail.com"â€¨EMAIL_PASSWORD="password_app_gmail"â€¨EMAIL_RECIPIENT="direttore@beneculturale.it"â€¨MONITORING_DURATION_MINUTES=600Â  # Esempio: 10 ore (08:00 - 18:00)â€¨
Proteggi il file .env per la sicurezza delle credenziali:
chmod 600 .envâ€¨
4. ğŸ Script Python: presenze_turisti.py
Crea questo file e copia il codice al suo interno. Ãˆ il cuore del sistema di rilevamento e logging.
import cv2â€¨import numpy as npâ€¨import osâ€¨from datetime import datetime, timedeltaâ€¨from dotenv import load_dotenvâ€¨import smtplibâ€¨from email.mime.text import MIMETextâ€¨import timeâ€¨â€¨load_dotenv()â€¨â€¨# Configurazione del Monitoraggioâ€¨# Durata del monitoraggio in minuti. Default: 600 minuti (10 ore, es. 08:00 - 18:00)â€¨DURATION = int(os.getenv("MONITORING_DURATION_MINUTES", 600))â€¨DETECTION_INTERVAL = 5 # Secondi tra un rilevamento e il successivoâ€¨â€¨# Email Configurationâ€¨EMAIL_SENDER = os.getenv("EMAIL_SENDER")â€¨EMAIL_PASSWORD = os.getenv("EMAIL_PASSWORD")â€¨EMAIL_RECIPIENT = os.getenv("EMAIL_RECIPIENT")â€¨â€¨# Modello di Rilevamento e Logâ€¨CASCADE = cv2.CascadeClassifier("haarcascade_fullbody.xml")â€¨LOG_FILE = "presenze_log.txt"â€¨â€¨def detect_people(frame):â€¨Â  Â  """â€¨Â  Â  Rileva i corpi umani (turisti) nel frame.â€¨Â  Â  â€¨Â  Â  Procedura:â€¨Â  Â  1. Converte il frame in scala di grigi.â€¨Â  Â  2. Cerca corpi umani utilizzando Haar Cascade.â€¨Â  Â  â€¨Â  Â  Restituisce: numero di persone rilevateâ€¨Â  Â  """â€¨Â  Â  if CASCADE.empty():â€¨Â  Â  Â  Â  # Verifica di sicurezzaâ€¨Â  Â  Â  Â  print("âœ— Errore: Modello Haar Cascade non caricato.")â€¨Â  Â  Â  Â  return 0â€¨â€¨Â  Â  gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)â€¨Â  Â  â€¨Â  Â  # Rileva tutti i corpi umani nel frameâ€¨Â  Â  bodies = CASCADE.detectMultiScale(â€¨Â  Â  Â  Â  gray, â€¨Â  Â  Â  Â  scaleFactor=1.1, â€¨Â  Â  Â  Â  minNeighbors=5, â€¨Â  Â  Â  Â  minSize=(30, 60), # Dimensioni minime del corpo da rilevareâ€¨Â  Â  Â  Â  flags=cv2.CASCADE_SCALE_IMAGEâ€¨Â  Â  )â€¨Â  Â  â€¨Â  Â  # Restituisce semplicemente il conteggio dei corpi rilevatiâ€¨Â  Â  return len(bodies)â€¨â€¨def write_log(msg):â€¨Â  Â  """Scrive un messaggio nel file di log con timestamp."""â€¨Â  Â  ts = datetime.now().strftime("%H:%M:%S")â€¨Â  Â  line = f"[{ts}] {msg}"â€¨Â  Â  â€¨Â  Â  try:â€¨Â  Â  Â  Â  with open(LOG_FILE, 'a') as f:â€¨Â  Â  Â  Â  Â  Â  f.write(line + "\n")â€¨Â  Â  Â  Â  print(line)â€¨Â  Â  except IOError as e:â€¨Â  Â  Â  Â  print(f"âœ— Errore scrittura log: {e}")â€¨â€¨def send_email():â€¨Â  Â  """Legge il log e lo invia via email."""â€¨Â  Â  if not all([EMAIL_SENDER, EMAIL_PASSWORD, EMAIL_RECIPIENT]):â€¨Â  Â  Â  Â  print("âœ— Credenziali email mancanti. Report non inviato.")â€¨Â  Â  Â  Â  returnâ€¨â€¨Â  Â  try:â€¨Â  Â  Â  Â  with open(LOG_FILE, 'r') as f:â€¨Â  Â  Â  Â  Â  Â  log = f.read()â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  # Crea messaggio emailâ€¨Â  Â  Â  Â  today_date = datetime.now().strftime('%d/%m/%Y')â€¨Â  Â  Â  Â  msg = MIMEText(f"Report Presenze Turisti:\n\n{log}")â€¨Â  Â  Â  Â  msg['Subject'] = f"Report Affluenza - {today_date}"â€¨Â  Â  Â  Â  msg['From'] = EMAIL_SENDERâ€¨Â  Â  Â  Â  msg['To'] = EMAIL_RECIPIENTâ€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  # Invia via Gmailâ€¨Â  Â  Â  Â  with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:â€¨Â  Â  Â  Â  Â  Â  server.login(EMAIL_SENDER, EMAIL_PASSWORD)â€¨Â  Â  Â  Â  Â  Â  server.sendmail(EMAIL_SENDER, EMAIL_RECIPIENT, msg.as_string())â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  print("âœ“ Email inviata con successo")â€¨Â  Â  except smtplib.SMTPAuthenticationError:â€¨Â  Â  Â  Â  print("âœ— Errore invio email: Credenziali non valide. Assicurati di usare una 'Password per App' di Gmail.")â€¨Â  Â  except FileNotFoundError:â€¨Â  Â  Â  Â  print("âœ— Errore invio email: File di log non trovato.")â€¨Â  Â  except Exception as e:â€¨Â  Â  Â  Â  print(f"âœ— Errore invio email: {e}")â€¨â€¨def main():â€¨Â  Â  """Loop principale di monitoraggio."""â€¨Â  Â  print(f"ğŸ›ï¸ Monitoraggio Turisti - Durata configurata: {DURATION} minuti")â€¨â€¨Â  Â  # Verifica la presenza del modello Haar Cascadeâ€¨Â  Â  if not os.path.exists(CASCADE.getFilename()):â€¨Â  Â  Â  Â  print(f"âœ— Errore: File modello {CASCADE.getFilename()} non trovato. Assicurati che sia stato scaricato correttamente.")â€¨Â  Â  Â  Â  returnâ€¨Â  Â  â€¨Â  Â  # Inizializza file di logâ€¨Â  Â  try:â€¨Â  Â  Â  Â  duration_hours = DURATION / 60â€¨Â  Â  Â  Â  with open(LOG_FILE, 'w') as f:â€¨Â  Â  Â  Â  Â  Â  f.write(f"Inizio monitoraggio: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")â€¨Â  Â  Â  Â  Â  Â  f.write(f"Durata configurata: {DURATION} minuti ({duration_hours} ore)\n")â€¨Â  Â  Â  Â  Â  Â  f.write("-" * 50 + "\n\n")â€¨Â  Â  except IOError as e:â€¨Â  Â  Â  Â  print(f"âœ— Impossibile creare il file di log: {e}")â€¨Â  Â  Â  Â  returnâ€¨Â  Â  â€¨Â  Â  # Apri fotocamera (indice 0 Ã¨ tipico)â€¨Â  Â  cap = cv2.VideoCapture(0)â€¨Â  Â  â€¨Â  Â  if not cap.isOpened():â€¨Â  Â  Â  Â  write_log("âš ï¸ Errore: Impossibile aprire la fotocamera. Il dispositivo potrebbe non essere disponibile.")â€¨Â  Â  Â  Â  print("âœ— Fotocamera non disponibile. Esco.")â€¨Â  Â  Â  Â  send_email() â€¨Â  Â  Â  Â  returnâ€¨Â  Â  â€¨Â  Â  write_log("Fotocamera aperta con successo. Inizio loop di monitoraggio.")â€¨Â  Â  â€¨Â  Â  # Calcola tempo di fineâ€¨Â  Â  start_time = datetime.now()â€¨Â  Â  end_time = start_time + timedelta(minutes=DURATION)â€¨Â  Â  last_detection = start_timeâ€¨Â  Â  â€¨Â  Â  # Loop di monitoraggioâ€¨Â  Â  while datetime.now() < end_time:â€¨Â  Â  Â  Â  ret, frame = cap.read()â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  if not ret:â€¨Â  Â  Â  Â  Â  Â  print("âš ï¸ Errore lettura fotocamera. Riprovo in 1 secondo.")â€¨Â  Â  Â  Â  Â  Â  time.sleep(1)â€¨Â  Â  Â  Â  Â  Â  continueâ€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  # Rileva solo ogni DETECTION_INTERVAL secondiâ€¨Â  Â  Â  Â  now = datetime.now()â€¨Â  Â  Â  Â  if (now - last_detection).seconds >= DETECTION_INTERVAL:â€¨Â  Â  Â  Â  Â  Â  count = detect_people(frame)â€¨Â  Â  Â  Â  Â  Â  â€¨Â  Â  Â  Â  Â  Â  # Logga solo se il conteggio Ã¨ maggiore di zeroâ€¨Â  Â  Â  Â  Â  Â  if count > 0:â€¨Â  Â  Â  Â  Â  Â  Â  Â  write_log(f"Persone rilevate: {count}")â€¨Â  Â  Â  Â  Â  Â  â€¨Â  Â  Â  Â  Â  Â  # Aggiorna il tempo dell'ultima rilevazione per il prossimo checkâ€¨Â  Â  Â  Â  Â  Â  last_detection = nowâ€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  # Breve attesa per non sovraccaricare la CPUâ€¨Â  Â  Â  Â  cv2.waitKey(100) â€¨Â  Â  â€¨Â  Â  # Ferma la fotocamera e chiudi finestreâ€¨Â  Â  cap.release()â€¨Â  Â  cv2.destroyAllWindows()â€¨Â  Â  â€¨Â  Â  # Termina monitoraggioâ€¨Â  Â  write_log("Monitoraggio terminato")â€¨Â  Â  print("\nInvio report via email...")â€¨Â  Â  â€¨Â  Â  # Tentativo di invio emailâ€¨Â  Â  send_email()â€¨Â  Â  â€¨Â  Â  # Elimina file di log localeâ€¨Â  Â  try:â€¨Â  Â  Â  Â  if os.path.exists(LOG_FILE):â€¨Â  Â  Â  Â  Â  Â  os.remove(LOG_FILE)â€¨Â  Â  except Exception as e:â€¨Â  Â  Â  Â  print(f"Avviso: Impossibile eliminare il file di log locale: {e}")â€¨â€¨Â  Â  print("âœ“ Monitoraggio Turisti completato.")â€¨â€¨if __name__ == "__main__":â€¨Â  Â  main()â€¨
5. âš™ï¸ Script Bash: start_turisti_monitor.sh
Crea questo script nella directory principale. Deve essere reso eseguibile e utilizzato da Cron.
#!/bin/bashâ€¨â€¨# =================================================================â€¨# SCRIPT DI AVVIO PER IL MONITORAGGIO DEI TURISTI (Per Cron)â€¨# =================================================================â€¨â€¨# !!! MODIFICA QUESTO PERCORSO !!!â€¨# Deve puntare alla posizione esatta della tua cartella Vision sul Raspberry Piâ€¨PROJECT_DIR="/home/settoretecnico/Downloads/Vision"â€¨â€¨# Vai alla directory del progettoâ€¨cd "$PROJECT_DIR" || { echo "Errore CRON: La directory di progetto non Ã¨ stata trovata in $PROJECT_DIR"; exit 1; }â€¨â€¨# Attiva l'ambiente virtualeâ€¨source venv/bin/activate || { echo "Errore CRON: Impossibile attivare l'ambiente virtuale venv. Verifica il percorso."; exit 1; }â€¨â€¨# Esegui lo script Python e reindirizza l'output a un log di sistemaâ€¨python presenze_turisti.py >> monitoraggio_output.log 2>&1â€¨â€¨# Disattiva l'ambiente virtualeâ€¨deactivateâ€¨â€¨# Fine scriptâ€¨
6. â° Automazione (Cron Setup)
Per avviare il monitoraggio automaticamente all'orario di apertura (es. 08:00) e tutti i giorni della settimana:
	1	Rendi lo script di avvio eseguibile:â€¨chmod +x start_turisti_monitor.shâ€¨â€¨
	2	Apri l'editor Cron:â€¨crontab -eâ€¨â€¨
	3	Aggiungi la seguente riga. Ricorda di verificare il percorso!â€¨# Avvia lo script alle 08:00, tutti i giorni (dal lunedÃ¬ alla domenica)â€¨0 8 * * * /home/settoretecnico/Downloads/Vision/start_turisti_monitor.shâ€¨â€¨
âš ï¸ Note Importanti
	â€¢	Verifica la Directory: Assicurati che PROJECT_DIR in start_turisti_monitor.sh sia corretto. Un errore nel percorso impedisce l'avvio automatico.
	â€¢	Log di Sistema: Per verificare l'esecuzione e diagnosticare eventuali problemi del sistema, controlla il file monitoraggio_output.log.
	â€¢	Privacy: Non viene salvata alcuna immagine o video. Solo il conteggio numerico e l'orario vengono registrati.
